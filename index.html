<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MalerBedarf VisionAI ‚Äì KI-Farbvorschau</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #003d5b;
            --accent: #00d4ff;
            --accent-light: #66e8ff;
            --gradient: linear-gradient(135deg, #00d4ff, #0099cc);
            --bg: #f0f8ff;
            --surface: rgba(255, 255, 255, 0.9);
            --glass: rgba(255, 255, 255, 0.25);
            --border: rgba(255, 255, 255, 0.2);
            --text: #1e293b;
            --radius: 24px;
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #a0d8ef 0%, #e0f2fe 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            padding: 60px 30px;
            background: var(--gradient);
            border-radius: var(--radius);
            color: white;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            margin-bottom: 50px;
        }
        .header h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 16px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .header p {
            font-size: 20px;
            opacity: 0.95;
            max-width: 800px;
            margin: 0 auto;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: var(--glass);
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: 600;
            margin-top: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .main {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 50px;
            align-items: start;
        }
        @media (max-width: 1100px) {
            .main { grid-template-columns: 1fr; }
            .header h1 { font-size: 38px; }
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .section {
            background: var(--surface);
            backdrop-filter: blur(16px);
            border-radius: var(--radius);
            padding: 36px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        .section:hover {
            transform: translateY(-8px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }
        .section h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .upload {
            border: 3px dashed var(--accent);
            border-radius: var(--radius);
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            background: rgba(0,212,255,0.05);
            transition: var(--transition);
        }
        .upload:hover {
            background: rgba(0,212,255,0.15);
            transform: scale(1.02);
        }
        .upload span {
            font-size: 80px;
            display: block;
            margin-bottom: 20px;
        }
        .canvas-area {
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
            cursor: crosshair;
        }
        .wrapper {
            position: relative;
            background: #e2e8f0;
        }
        #selectionBox {
            position: absolute;
            border: 3px dashed var(--accent);
            background: rgba(0,212,255,0.2);
            pointer-events: none;
            display: none;
            border-radius: 8px;
        }
        .loading {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        .spinner {
            width: 70px;
            height: 70px;
            border: 6px solid rgba(0,212,255,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn {
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            margin-top: 16px;
        }
        .primary {
            background: var(--gradient);
            color: white;
            box-shadow: 0 10px 30px rgba(0,212,255,0.4);
        }
        .primary:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,212,255,0.5);
        }
        .secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .secondary:hover {
            background: var(--primary);
            color: white;
        }
        .palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin: 24px 0;
        }
        .color-swatch {
            height: 80px;
            border-radius: 16px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .color-swatch:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .custom-color {
            display: flex;
            gap: 16px;
            margin-top: 20px;
        }
        .custom-color input[type="color"] {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            cursor: pointer;
            border: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MalerBedarf VisionAI</h1>
            <p>Erleben Sie die Zukunft der Farbberatung ‚Äì photorealistische KI-Vorschauen f√ºr Ihr Zuhause</p>
            <div class="badge">‚ú® Powered by Google Gemini</div>
        </div>

        <div class="main">
            <div class="sidebar">
                <div class="section">
                    <h2>üì§ Foto hochladen</h2>
                    <div class="upload" id="uploadArea">
                        <span>üè†</span>
                        <div style="font-size:18px; margin-top:16px;">Ziehen Sie Ihr Foto hierher<br>oder klicken Sie zum Ausw√§hlen</div>
                        <input type="file" id="imageInput" accept="image/*" style="display:none;">
                    </div>
                </div>

                <div class="section">
                    <h2>üñºÔ∏è Bereich ausw√§hlen</h2>
                    <p style="font-size:16px; line-height:1.6; color:#555;">
                        Klicken und ziehen Sie einen Rahmen um die zu f√§rbende Fl√§che (z. B. Fassade, Wand).
                    </p>
                    <button class="btn secondary" id="resetSelection">‚Üª Auswahl zur√ºcksetzen</button>
                </div>

                <div class="section">
                    <h2>üé® Farbe w√§hlen</h2>
                    <div class="palette" id="colorPalette"></div>
                    <div class="custom-color">
                        <input type="color" id="colorPicker" value="#00a8cc">
                        <input type="text" id="colorInput" placeholder="#00A8CC" style="flex:1; padding:16px; border-radius:16px; border:1px solid #ccc; font-family:monospace; font-size:16px;">
                    </div>
                </div>

                <div class="section">
                    <h2>üöÄ Ihr Ergebnis</h2>
                    <button class="btn secondary" id="downloadBtn" disabled>‚¨áÔ∏è Bild speichern</button>
                    <button class="btn primary" id="requestBtn" disabled>‚úâÔ∏è Kostenlose Beratung anfragen</button>
                </div>
            </div>

            <div class="canvas-area">
                <div class="loading" id="loading" style="display:none;">
                    <div class="spinner"></div>
                    <p style="font-size:20px; margin-top:32px; font-weight:600;">VisionAI erstellt Ihre Vorschau...</p>
                </div>
                <div id="canvasWrapper" class="wrapper">
                    <canvas id="originalCanvas"></canvas>
                    <div id="selectionBox"></div>
                </div>
                <canvas id="modifiedCanvas" style="position:absolute; top:0; left:0; width:100%; height:100%; display:none;"></canvas>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://malerbedarf-visionai.onrender.com';

        const state = { img: null, mask: null, color: '#00a8cc', selecting: false, startX: 0, startY: 0, hasMask: false };
        const el = {
            upload: document.getElementById('uploadArea'),
            input: document.getElementById('imageInput'),
            wrapper: document.getElementById('canvasWrapper'),
            original: document.getElementById('originalCanvas'),
            modified: document.getElementById('modifiedCanvas'),
            selectionBox: document.getElementById('selectionBox'),
            reset: document.getElementById('resetSelection'),
            palette: document.getElementById('colorPalette'),
            picker: document.getElementById('colorPicker'),
            text: document.getElementById('colorInput'),
            download: document.getElementById('downloadBtn'),
            request: document.getElementById('requestBtn'),
            loading: document.getElementById('loading')
        };

        // Premium Farbpalette
        ['#ffffff','#f8f4e8','#e8e8e8','#d4c4a8','#d6eef5','#c8e6c9','#c9a876','#7a7a7a','#003d5b','#00a8cc','#2d7a4a','#c85a54'].forEach(hex => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.background = hex;
            swatch.onclick = () => {
                state.color = hex;
                el.picker.value = hex;
                el.text.value = hex.toUpperCase();
                if (state.hasMask) applyKI();
            };
            el.palette.appendChild(swatch);
        });

        el.upload.onclick = () => el.input.click();
        el.input.onchange = e => e.target.files[0] && loadImage(e.target.files[0]);

        function loadImage(file) {
            if (file.size > 15 * 1024 * 1024) return alert('Bild zu gro√ü (max. 15 MB)');
            const reader = new FileReader();
            reader.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    const max = 1400;
                    const ratio = Math.min(max / img.width, max / img.height, 1);
                    const w = img.width * ratio;
                    const h = img.height * ratio;

                    el.wrapper.style.width = w + 'px';
                    el.wrapper.style.height = h + 'px';
                    el.wrapper.style.maxWidth = '100%';

                    el.original.width = w; el.original.height = h;
                    el.original.getContext('2d').drawImage(img, 0, 0, w, h);

                    el.modified.width = w; el.modified.height = h;

                    state.img = el.original;
                    state.mask = document.createElement('canvas');
                    state.mask.width = w; state.mask.height = h;
                    const ctx = state.mask.getContext('2d');
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0, 0, w, h);

                    enableRectangleSelection();
                    state.hasMask = false;
                    el.download.disabled = el.request.disabled = true;
                    el.modified.style.display = 'none';
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        function enableRectangleSelection() {
            el.wrapper.onmousedown = e => {
                if (e.button !== 0) return;
                const rect = el.wrapper.getBoundingClientRect();
                state.startX = e.clientX - rect.left;
                state.startY = e.clientY - rect.top;
                state.selecting = true;
                el.selectionBox.style.display = 'block';
                el.selectionBox.style.left = state.startX + 'px';
                el.selectionBox.style.top = state.startY + 'px';
                el.selectionBox.style.width = '0';
                el.selectionBox.style.height = '0';
            };

            el.wrapper.onmousemove = e => {
                if (!state.selecting) return;
                const rect = el.wrapper.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const left = Math.min(state.startX, x);
                const top = Math.min(state.startY, y);
                const width = Math.abs(x - state.startX);
                const height = Math.abs(y - state.startY);

                el.selectionBox.style.left = left + 'px';
                el.selectionBox.style.top = top + 'px';
                el.selectionBox.style.width = width + 'px';
                el.selectionBox.style.height = height + 'px';
            };

            document.onmouseup = () => {
                if (!state.selecting) return;
                state.selecting = false;
                el.selectionBox.style.display = 'none';

                const box = el.selectionBox.getBoundingClientRect();
                const wrap = el.wrapper.getBoundingClientRect();

                const scaleX = state.mask.width / wrap.width;
                const scaleY = state.mask.height / wrap.height;

                const x = (box.left - wrap.left) * scaleX;
                const y = (box.top - wrap.top) * scaleY;
                const w = box.width * scaleX;
                const h = box.height * scaleY;

                if (w > 10 && h > 10) {
                    state.mask.getContext('2d').fillStyle = 'white';
                    state.mask.getContext('2d').fillRect(x, y, w, h);
                    state.hasMask = true;
                    applyKI();
                }
            };

            el.reset.onclick = () => {
                const ctx = state.mask.getContext('2d');
                ctx.clearRect(0, 0, state.mask.width, state.mask.height);
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, state.mask.width, state.mask.height);
                state.hasMask = false;
                el.modified.style.display = 'none';
                el.download.disabled = el.request.disabled = true;
            };
        }

        async function applyKI() {
            if (!state.hasMask) return;
            el.loading.style.display = 'flex';
            try {
                const res = await fetch(BACKEND_URL + '/api/recolor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        originalImage: state.img.toDataURL('image/jpeg', 0.85),
                        maskImage: state.mask.toDataURL('image/png'),
                        targetColor: state.color
                    })
                });
                if (!res.ok) throw new Error('Server-Fehler ' + res.status);
                const data = await res.json();
                const img = new Image();
                img.onload = () => {
                    el.modified.getContext('2d').clearRect(0, 0, el.modified.width, el.modified.height);
                    el.modified.getContext('2d').drawImage(img, 0, 0, el.modified.width, el.modified.height);
                    el.modified.style.display = 'block';
                    el.download.disabled = false;
                    el.request.disabled = false;
                    el.loading.style.display = 'none';
                };
                img.src = data.imageDataURL;
            } catch (err) {
                el.loading.style.display = 'none';
                alert('KI-Fehler: ' + err.message);
            }
        }

        el.picker.oninput = e => {
            state.color = e.target.value;
            el.text.value = state.color.toUpperCase();
            if (state.hasMask) applyKI();
        };

        el.text.onblur = () => {
            let val = el.text.value.trim();
            if (!val.startsWith('#')) val = '#' + val;
            if (/^#[0-9A-F]{6}$/i.test(val)) {
                state.color = val.toUpperCase();
                el.picker.value = state.color;
                if (state.hasMask) applyKI();
            }
        };

        el.download.onclick = () => {
            const link = document.createElement('a');
            link.download = 'malerbedarf-visionai-vorschau.png';
            link.href = el.modified.toDataURL();
            link.click();
        };
    </script>
</body>
</html>
