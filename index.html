<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MalerBedarf VisionAI ‚Äì KI-Farbvorschau & Fachberater</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #003d5b;
            --accent: #00d4ff;
            --gradient: linear-gradient(135deg, #00d4ff, #0099cc);
            --glass: rgba(255, 255, 255, 0.15);
            --border: rgba(255, 255, 255, 0.3);
            --shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a1e3a, #001f3f);
            color: white;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            text-align: center;
            padding: 80px 40px;
            background: var(--gradient);
            border-radius: 32px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(20px);
            margin-bottom: 60px;
        }
        .header h1 { font-size: 56px; font-weight: 700; margin-bottom: 20px; }
        .badge { 
            display: inline-flex; align-items: center; gap: 16px; 
            background: var(--glass); padding: 16px 32px; border-radius: 50px; 
            font-weight: 700; backdrop-filter: blur(20px); border: 1px solid var(--border); 
            box-shadow: 0 10px 30px rgba(0,212,255,0.3); animation: glow 4s infinite alternate; 
        }
        @keyframes glow { 0% { box-shadow: 0 10px 30px rgba(0,212,255,0.3); } 100% { box-shadow: 0 20px 60px rgba(0,212,255,0.6); } }
        .main { display: grid; grid-template-columns: 1fr 2fr; gap: 60px; }
        @media (max-width: 1100px) { .main { grid-template-columns: 1fr; } }
        .sidebar { display: flex; flex-direction: column; gap: 40px; }
        .section {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: transform 0.5s;
        }
        .section:hover { transform: translateY(-20px); }
        .section h2 { font-size: 28px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px; }
        .upload {
            border: 4px dashed var(--accent);
            border-radius: 32px;
            padding: 80px 40px;
            text-align: center;
            cursor: pointer;
            transition: 0.4s;
        }
        .upload:hover { background: rgba(0,212,255,0.2); transform: scale(1.05); }
        .canvas-area {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
        }
        .wrapper { position: relative; background: #001f3f; border-radius: 32px; overflow: hidden; }
        #selectionBox { position: absolute; border: 4px dashed var(--accent); background: rgba(0,212,255,0.3); pointer-events: none; display: none; border-radius: 16px; }
        .loading { position: absolute; inset: 0; background: rgba(0,31,63,0.9); backdrop-filter: blur(20px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; }
        .spinner { width: 80px; height: 80px; border: 8px solid rgba(0,212,255,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn {
            padding: 20px 40px;
            border: none;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.4s;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .primary { background: var(--gradient); color: white; }
        .primary:hover { transform: translateY(-10px); box-shadow: 0 20px 50px rgba(0,212,255,0.6); }
        .secondary { background: var(--glass); color: white; backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .secondary:hover { background: rgba(255,255,255,0.3); }
        .palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .color-swatch { height: 100px; border-radius: 24px; cursor: pointer; transition: 0.4s; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .color-swatch:hover { transform: translateY(-20px) scale(1.1); }
        .custom-color { display: flex; gap: 20px; margin-top: 30px; }
        .custom-color input[type="color"] { width: 120px; height: 120px; border-radius: 24px; cursor: pointer; }
        /* Fachberater Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(30px);
            border-radius: 32px;
            padding: 50px;
            width: 90%;
            max-width: 600px;
            border: 1px solid var(--border);
            box-shadow: 0 30px 80px rgba(0,0,0,0.5);
            position: relative;
        }
        .modal h3 { font-size: 32px; margin-bottom: 24px; text-align: center; }
        .modal p { font-size: 18px; line-height: 1.6; margin-bottom: 30px; text-align: center; opacity: 0.9; }
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
        }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 36px;
            cursor: pointer;
            opacity: 0.7;
        }
        .close-modal:hover { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MalerBedarf VisionAI</h1>
            <p>KI-Farbvorschau + pers√∂nliche Beratung vor Ort</p>
            <div class="badge">üè† Fachberater kommt zu Ihnen nach Hause</div>
        </div>

        <div class="main">
            <div class="sidebar">
                <div class="section">
                    <h2>üì§ Foto hochladen</h2>
                    <div class="upload" id="uploadArea">
                        <span style="font-size:100px;">üè†</span>
                        <div style="font-size:20px; margin-top:24px;">Ziehen oder klicken</div>
                        <input type="file" id="imageInput" accept="image/*" style="display:none;">
                    </div>
                </div>

                <div class="section">
                    <h2>üñºÔ∏è Bereich ausw√§hlen</h2>
                    <p>Rahmen ziehen um die zu f√§rbende Fl√§che</p>
                    <button class="btn secondary" id="resetSelection">‚Üª Zur√ºcksetzen</button>
                </div>

                <div class="section">
                    <h2>üé® Farbe w√§hlen</h2>
                    <div class="palette" id="colorPalette"></div>
                    <div class="custom-color">
                        <input type="color" id="colorPicker" value="#00a8cc">
                        <input type="text" id="colorInput" placeholder="#00A8CC">
                    </div>
                </div>

                <div class="section">
                    <h2>üöÄ Ihr Ergebnis</h2>
                    <button class="btn secondary" id="downloadBtn" disabled>‚¨áÔ∏è Bild speichern</button>
                    <button class="btn primary" id="requestBtn" disabled>‚úâÔ∏è Beratung anfragen</button>
                    <button class="btn primary" id="homeVisitBtn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24); margin-top:30px;">
                        üè° Fachberater zu mir nach Hause bestellen
                    </button>
                </div>
            </div>

            <div class="canvas-area">
                <div class="loading" id="loading" style="display:none;">
                    <div class="spinner"></div>
                    <p style="font-size:24px; margin-top:40px;">VisionAI erstellt Ihre Vorschau...</p>
                </div>
                <div id="canvasWrapper" class="wrapper">
                    <canvas id="originalCanvas"></canvas>
                    <div id="selectionBox"></div>
                </div>
                <canvas id="modifiedCanvas" style="position:absolute; top:0; left:0; width:100%; height:100%; display:none;"></canvas>
            </div>
        </div>
    </div>

    <!-- Fachberater Modal -->
    <div class="modal" id="homeVisitModal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <h3>üè° Fachberater vor Ort</h3>
            <p>
                Lassen Sie einen unserer Malermeister kostenlos & unverbindlich zu Ihnen nach Hause kommen.<br><br>
                <strong>Wir messen Ihren bestehenden Farbton mit professionellem Spektrometer exakt aus</strong> ‚Äì 
                damit wir ihn perfekt nachbilden oder Ihnen passende neue T√∂ne vorschlagen k√∂nnen.<br><br>
                Pers√∂nliche Beratung direkt an Ihrer Fassade oder Wand ‚Äì der beste Weg zur perfekten Farbwahl!
            </p>
            <form id="homeVisitForm">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" required>
                </div>
                <div class="form-group">
                    <label>Adresse *</label>
                    <input type="text" required>
                </div>
                <div class="form-group">
                    <label>Telefon oder E-Mail *</label>
                    <input type="text" required>
                </div>
                <div class="form-group">
                    <label>Wunschtermin (optional)</label>
                    <input type="text" placeholder="z. B. n√§chste Woche vormittags">
                </div>
                <div class="form-group">
                    <label>Nachricht (optional)</label>
                    <textarea placeholder="z. B. 'Ich m√∂chte den aktuellen Fassadenfarbton ausmessen lassen'"></textarea>
                </div>
                <button type="submit" class="btn primary" style="margin-top:30px;">Anfrage absenden</button>
            </form>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://malerbedarf-visionai.onrender.com';

        const state = { img: null, mask: null, color: '#00a8cc', selecting: false, startX: 0, startY: 0, hasMask: false };
        const el = {
            upload: document.getElementById('uploadArea'),
            input: document.getElementById('imageInput'),
            wrapper: document.getElementById('canvasWrapper'),
            original: document.getElementById('originalCanvas'),
            modified: document.getElementById('modifiedCanvas'),
            selectionBox: document.getElementById('selectionBox'),
            reset: document.getElementById('resetSelection'),
            palette: document.getElementById('colorPalette'),
            picker: document.getElementById('colorPicker'),
            text: document.getElementById('colorInput'),
            download: document.getElementById('downloadBtn'),
            request: document.getElementById('requestBtn'),
            homeVisitBtn: document.getElementById('homeVisitBtn'),
            modal: document.getElementById('homeVisitModal'),
            closeModal: document.getElementById('closeModal'),
            loading: document.getElementById('loading')
        };

        // Farbpalette
        ['#ffffff','#f5f1e8','#e8e8e8','#d4c4a8','#d6eef5','#c8e6c9','#c9a876','#7a7a7a','#003d5b','#00a8cc','#2d7a4a','#c85a54'].forEach(hex => {
            const swatch = document.createElement('div');
            swatch.style.background = hex;
            swatch.style.height = '100px';
            swatch.style.borderRadius = '24px';
            swatch.style.cursor = 'pointer';
            swatch.style.transition = '0.4s';
            swatch.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
            swatch.onclick = () => {
                state.color = hex;
                el.picker.value = hex;
                el.text.value = hex.toUpperCase();
                if (state.hasMask) applyKI();
            };
            el.palette.appendChild(swatch);
        });

        // Fachberater Modal
        el.homeVisitBtn.onclick = () => el.modal.classList.add('active');
        el.closeModal.onclick = () => el.modal.classList.remove('active');
        el.modal.onclick = e => e.target === el.modal && el.modal.classList.remove('active');

        document.getElementById('homeVisitForm').onsubmit = e => {
            e.preventDefault();
            alert('Vielen Dank! Ihre Anfrage f√ºr einen Fachberater vor Ort wurde gesendet. Wir melden uns bald bei Ihnen.');
            el.modal.classList.remove('active');
        };

        // Upload & Bild laden
        el.upload.onclick = () => el.input.click();
        el.input.onchange = e => e.target.files[0] && loadImage(e.target.files[0]);

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    const max = 1200;
                    const ratio = Math.min(max / img.width, max / img.height);
                    const w = img.width * ratio;
                    const h = img.height * ratio;

                    el.wrapper.style.width = w + 'px';
                    el.wrapper.style.height = h + 'px';

                    el.original.width = w; el.original.height = h;
                    el.original.getContext('2d').drawImage(img, 0, 0, w, h);

                    el.modified.width = w; el.modified.height = h;

                    state.img = el.original;
                    state.mask = document.createElement('canvas');
                    state.mask.width = w; state.mask.height = h;
                    state.mask.getContext('2d').fillStyle = 'black';
                    state.mask.getContext('2d').fillRect(0, 0, w, h);

                    enableRectangleSelection();
                    state.hasMask = false;
                    el.download.disabled = el.request.disabled = true;
                    el.modified.style.display = 'none';
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        function enableRectangleSelection() {
            el.wrapper.onmousedown = e => {
                if (e.button !== 0) return;
                const rect = el.wrapper.getBoundingClientRect();
                state.startX = e.clientX - rect.left;
                state.startY = e.clientY - rect.top;
                state.selecting = true;
                el.selectionBox.style.display = 'block';
                el.selectionBox.style.left = state.startX + 'px';
                el.selectionBox.style.top = state.startY + 'px';
                el.selectionBox.style.width = '0';
                el.selectionBox.style.height = '0';
            };

            el.wrapper.onmousemove = e => {
                if (!state.selecting) return;
                const rect = el.wrapper.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;

                const left = Math.min(state.startX, currentX);
                const top = Math.min(state.startY, currentY);
                const width = Math.abs(currentX - state.startX);
                const height = Math.abs(currentY - state.startY);

                el.selectionBox.style.left = left + 'px';
                el.selectionBox.style.top = top + 'px';
                el.selectionBox.style.width = width + 'px';
                el.selectionBox.style.height = height + 'px';
            };

            document.onmouseup = () => {
                if (state.selecting) {
                    state.selecting = false;
                    el.selectionBox.style.display = 'none';

                    const box = el.selectionBox.getBoundingClientRect();
                    const wrapperRect = el.wrapper.getBoundingClientRect();

                    const scaleX = state.mask.width / wrapperRect.width;
                    const scaleY = state.mask.height / wrapperRect.height;

                    const x = (box.left - wrapperRect.left) * scaleX;
                    const y = (box.top - wrapperRect.top) * scaleY;
                    const w = box.width * scaleX;
                    const h = box.height * scaleY;

                    const ctx = state.mask.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(x, y, w, h);

                    state.hasMask = true;
                    applyKI();
                }
            };

            el.reset.onclick = () => {
                state.mask.getContext('2d').clearRect(0, 0, state.mask.width, state.mask.height);
                state.mask.getContext('2d').fillStyle = 'black';
                state.mask.getContext('2d').fillRect(0, 0, state.mask.width, state.mask.height);
                state.hasMask = false;
                el.modified.style.display = 'none';
                el.download.disabled = el.request.disabled = true;
            };
        }

        async function applyKI() {
            if (!state.hasMask) return;
            el.loading.style.display = 'flex';
            try {
                const res = await fetch(BACKEND_URL + '/api/recolor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        originalImage: state.img.toDataURL('image/jpeg', 0.9),
                        maskImage: state.mask.toDataURL('image/png'),
                        targetColor: state.color
                    })
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                const img = new Image();
                img.onload = () => {
                    el.modified.getContext('2d').drawImage(img, 0, 0);
                    el.modified.style.display = 'block';
                    el.download.disabled = false;
                    el.request.disabled = false;
                    el.loading.style.display = 'none';
                };
                img.src = data.imageDataURL;
            } catch (err) {
                el.loading.style.display = 'none';
                alert('KI-Fehler: ' + err.message + '. Bitte sp√§ter erneut versuchen.');
            }
        }

        el.picker.oninput = e => { state.color = e.target.value; el.text.value = state.color; if (state.hasMask) applyKI(); };
        el.text.onblur = () => {
            let color = el.text.value.trim().toUpperCase();
            if (!color.startsWith('#')) color = '#' + color;
            if (/^#[0-9A-F]{6}$/.test(color)) {
                state.color = color;
                el.picker.value = color;
                if (state.hasMask) applyKI();
            }
        };

        el.download.onclick = () => {
            const link = document.createElement('a');
            link.href = el.modified.toDataURL();
            link.download = 'malerbedarf-visionai-vorschau.png';
            link.click();
        };
    </script>
</body>
</html>
