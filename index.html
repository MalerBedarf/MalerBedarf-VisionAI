<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI-Farbvorschau Pro ‚Äì Malerbedarf Coburg</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #0a3d62;
            --color-primary-light: #1e5f8a;
            --color-accent: #00d4ff;
            --color-accent-dark: #00a8cc;
            --color-gradient: linear-gradient(135deg, #00d4ff, #0099cc);
            --color-success: #00d4aa;
            --color-bg: #f0f7ff;
            --color-surface: rgba(255, 255, 255, 0.85);
            --color-surface-solid: #ffffff;
            --color-border: rgba(10, 61, 98, 0.15);
            --color-text: #1a2d42;
            --color-text-light: #556677;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 16px 48px rgba(0, 0, 0, 0.15);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #c0e4ff 100%);
            color: var(--color-text);
            min-height: 100vh;
        }
        .farbvorschau-container { max-width: 1600px; margin: 40px auto; padding: 32px; background: var(--color-surface); backdrop-filter: blur(16px); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); border: 1px solid var(--color-border); }
        .farbvorschau-header { text-align: center; margin-bottom: 48px; padding: 40px 20px; background: var(--color-gradient); border-radius: var(--radius-lg); color: white; box-shadow: var(--shadow-soft); position: relative; overflow: hidden; }
        .farbvorschau-header h1 { font-size: 42px; font-weight: 700; margin-bottom: 12px; }
        .ki-badge { display: inline-flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 50px; font-size: 16px; font-weight: 600; margin-top: 20px; animation: pulse 4s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 20px rgba(0,212,255,0.3); } 50% { box-shadow: 0 0 30px rgba(0,212,255,0.6); } }
        .farbvorschau-main { display: grid; grid-template-columns: 1fr 1.8fr; gap: 40px; }
        @media (max-width: 1024px) { .farbvorschau-main { grid-template-columns: 1fr; } .farbvorschau-header h1 { font-size: 32px; } }
        .farbvorschau-sidebar { display: flex; flex-direction: column; gap: 24px; }
        .farbvorschau-section { background: var(--color-surface-solid); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 28px; box-shadow: var(--shadow-soft); transition: var(--transition); }
        .farbvorschau-section:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
        .farbvorschau-section h2 { font-size: 20px; font-weight: 600; color: var(--color-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .farbvorschau-upload-area { border: 3px dashed var(--color-accent); border-radius: var(--radius-md); padding: 48px 24px; text-align: center; cursor: pointer; background: linear-gradient(145deg, rgba(0,212,255,0.05), rgba(0,168,204,0.1)); transition: var(--transition); }
        .farbvorschau-upload-area:hover { transform: scale(1.02); background: linear-gradient(145deg, rgba(0,212,255,0.15), rgba(0,168,204,0.2)); }
        .farbvorschau-upload-icon { font-size: 64px; margin-bottom: 16px; }
        .farbvorschau-color-palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .farbvorschau-color-option { border-radius: var(--radius-sm); overflow: hidden; border: 3px solid transparent; cursor: pointer; transition: var(--transition); }
        .farbvorschau-color-option:hover { transform: translateY(-8px) scale(1.05); box-shadow: var(--shadow-hover); }
        .farbvorschau-color-option.selected { border-color: var(--color-accent); }
        .farbvorschau-color-option-box { height: 70px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px; text-shadow: 0 1px 4px rgba(0,0,0,0.6); }
        .farbvorschau-canvas-area { background: var(--color-surface-solid); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-soft); position: relative; }
        .farbvorschau-canvas-wrapper { aspect-ratio: 4 / 3; background: #e0e0e0; position: relative; overflow: hidden; }
        .farbvorschau-slider-handle::before { width: 56px; height: 56px; background: white; border: 3px solid var(--color-accent); border-radius: var(--radius-sm); box-shadow: var(--shadow-hover); }
        .farbvorschau-loading { position: absolute; inset: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .farbvorschau-spinner { width: 60px; height: 60px; border: 5px solid rgba(0,212,255,0.2); border-top-color: var(--color-accent); border-radius: 50%; animation: farbvorschau-spin 1s ease-in-out infinite; }
        @keyframes farbvorschau-spin { to { transform: rotate(360deg); } }
        .farbvorschau-button { padding: 16px 24px; border: none; border-radius: var(--radius-sm); font-size: 16px; font-weight: 600; cursor: pointer; transition: var(--transition); }
        .farbvorschau-button-primary { background: var(--color-gradient); color: white; }
        .farbvorschau-button-primary:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,212,255,0.4); }
        .farbvorschau-button-secondary { background: white; color: var(--color-primary); border: 2px solid var(--color-primary); }
        .farbvorschau-button-secondary:hover { background: var(--color-primary); color: white; }
        .smart-fill-btn { background: linear-gradient(135deg, #7c3aed, #ec4899); color: white; font-weight: 700; animation: pulse 3s infinite; margin-top: 16px; }
    </style>
</head>
<body>
    <div class="farbvorschau-container">
        <div class="farbvorschau-header">
            <h1>üé® KI-Farbvorschau Pro</h1>
            <p>Erleben Sie photorealistische Farbvorschauen ‚Äì powered by Google Gemini KI</p>
            <div class="ki-badge">‚ö° Gemini 2.5 Flash Image</div>
        </div>

        <div class="farbvorschau-main">
            <div class="farbvorschau-sidebar">
                <div class="farbvorschau-section">
                    <h2>üì§ 1. Foto hochladen</h2>
                    <div class="farbvorschau-upload-area" id="uploadArea">
                        <span class="farbvorschau-upload-icon">üè†</span>
                        <div>Ziehen Sie Ihr Foto hierher oder klicken Sie</div>
                        <input type="file" id="imageInput" accept="image/jpeg,image/png" />
                    </div>
                </div>

                <div class="farbvorschau-section">
                    <h2>üñåÔ∏è 2. Bereich markieren</h2>
                    <div class="farbvorschau-tools" style="display:flex; flex-direction:column; gap:8px;">
                        <button class="farbvorschau-button farbvorschau-button-secondary active" id="brushTool">‚úèÔ∏è Pinsel</button>
                        <button class="farbvorschau-button farbvorschau-button-secondary" id="eraseTool">üóëÔ∏è Radierer</button>
                        <button class="farbvorschau-button farbvorschau-button-secondary" id="resetSelection">‚Üª Zur√ºcksetzen</button>
                        <button class="farbvorschau-button smart-fill-btn" id="smartFillBtn" disabled>‚ú¶ KI-Automatik (bald)</button>
                    </div>
                </div>

                <div class="farbvorschau-section">
                    <h2>üé® 3. Farbe w√§hlen</h2>
                    <div class="farbvorschau-color-palette" id="colorPalette"></div>
                    <div style="margin-top:24px; display:flex; gap:12px;">
                        <input type="color" id="colorPicker" value="#00a8cc" style="width:80px; height:80px; border-radius:12px; cursor:pointer;" />
                        <input type="text" id="colorInput" placeholder="#00A8CC" style="flex:1; padding:12px; border-radius:12px; border:1px solid var(--color-border);" />
                    </div>
                </div>

                <div class="farbvorschau-section">
                    <h2>üöÄ 4. Ergebnis</h2>
                    <button class="farbvorschau-button farbvorschau-button-secondary" id="downloadBtn" disabled>‚¨áÔ∏è Bild speichern</button>
                    <button class="farbvorschau-button farbvorschau-button-primary" id="requestBtn" disabled>‚úâÔ∏è Beratung anfragen</button>
                </div>
            </div>

            <div class="farbvorschau-canvas-area">
                <div class="farbvorschau-loading" id="loading">
                    <div class="farbvorschau-spinner"></div>
                    <p>Google Gemini KI verarbeitet Ihr Bild...</p>
                    <small>Photorealistische Anpassung in Sekunden ‚ö°</small>
                </div>
                <div class="farbvorschau-canvas-wrapper" id="canvasWrapper">
                    <div class="farbvorschau-canvas-container" id="canvasContainer" style="display:none;">
                        <div class="farbvorschau-canvas-stack" id="canvasStack">
                            <canvas id="originalCanvas"></canvas>
                            <div class="farbvorschau-slider-container" id="sliderContainer">
                                <div class="farbvorschau-slider-track" id="sliderTrack">
                                    <canvas id="modifiedCanvas"></canvas>
                                </div>
                                <div class="farbvorschau-slider-handle" id="sliderHandle"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="padding:16px; display:flex; justify-content:space-between; font-size:14px; color:var(--color-text-light);">
                    <span>Vorher</span>
                    <span>Nachher ‚Äì KI-optimiert</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal bleibt wie im Original (kann bei Bedarf erg√§nzt werden) -->

    <script>
        (function() {
            'use strict';
            const CONFIG = {
                predefinedColors: [
                    { name: 'Wei√ü', hex: '#ffffff' }, { name: 'Creme', hex: '#f5f1e8' }, { name: 'Hellgrau', hex: '#e8e8e8' },
                    { name: 'Beige', hex: '#d4c4a8' }, { name: 'Hellblau', hex: '#d6eef5' }, { name: 'Mintgr√ºn', hex: '#c8e6c9' },
                    { name: 'Sand', hex: '#c9a876' }, { name: 'Dunkelgrau', hex: '#7a7a7a' }, { name: 'Marineblau', hex: '#003d5b' },
                    { name: 'Teal', hex: '#00a8cc' }, { name: 'Gr√ºn', hex: '#2d7a4a' }, { name: 'Terrakotta', hex: '#c85a54' }
                ],
                brushSize: 30,
                maxFileSize: 10 * 1024 * 1024
            };

            const state = { originalImage: null, maskCanvas: null, modifiedImage: null, currentColor: '#00a8cc', isDrawing: false, currentTool: 'brush', hasSelection: false };
            const elements = {
                uploadArea: document.getElementById('uploadArea'), imageInput: document.getElementById('imageInput'),
                brushTool: document.getElementById('brushTool'), eraseTool: document.getElementById('eraseTool'),
                resetSelection: document.getElementById('resetSelection'), colorPalette: document.getElementById('colorPalette'),
                colorPicker: document.getElementById('colorPicker'), colorInput: document.getElementById('colorInput'),
                downloadBtn: document.getElementById('downloadBtn'), requestBtn: document.getElementById('requestBtn'),
                originalCanvas: document.getElementById('originalCanvas'), modifiedCanvas: document.getElementById('modifiedCanvas'),
                canvasContainer: document.getElementById('canvasContainer'), loading: document.getElementById('loading'),
                sliderHandle: document.getElementById('sliderHandle'), sliderTrack: document.getElementById('sliderTrack'), canvasStack: document.getElementById('canvasStack')
            };

            function showMessage(text, type = 'info') {
                const msg = document.createElement('div');
                msg.textContent = text;
                msg.style.padding = '12px'; msg.style.margin = '16px 0'; msg.style.borderRadius = '12px';
                msg.style.background = type === 'success' ? 'rgba(0,212,170,0.1)' : 'rgba(220,53,69,0.1)';
                document.querySelector('.farbvorschau-canvas-area').prepend(msg);
                setTimeout(() => msg.remove(), 5000);
            }

            function loadImage(file) {
                if (file.size > CONFIG.maxFileSize) return showMessage('Datei zu gro√ü (max. 10 MB)', 'error');
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxDim = 1200;
                        const ratio = Math.min(maxDim / img.width, maxDim / img.height);
                        canvas.width = img.width * ratio; canvas.height = img.height * ratio;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        state.originalImage = canvas;
                        initializeCanvases();
                        showMessage('Bild geladen ‚Äì jetzt Bereich markieren', 'success');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            function initializeCanvases() {
                const w = state.originalImage.width, h = state.originalImage.height;
                elements.originalCanvas.width = w; elements.originalCanvas.height = h;
                elements.originalCanvas.getContext('2d').drawImage(state.originalImage, 0, 0);
                elements.modifiedCanvas.width = w; elements.modifiedCanvas.height = h;

                state.maskCanvas = document.createElement('canvas');
                state.maskCanvas.width = w; state.maskCanvas.height = h;
                state.maskCanvas.getContext('2d').fillStyle = 'black';
                state.maskCanvas.getContext('2d').fillRect(0, 0, w, h); // Wei√ü = zu √§ndern

                elements.canvasContainer.style.display = 'block';
                initializeSlider();
                updateButtonStates();
            }

            function drawOnMask(x, y, erase = false) {
                const ctx = state.maskCanvas.getContext('2d');
                const rect = elements.originalCanvas.getBoundingClientRect();
                const scaleX = state.maskCanvas.width / rect.width;
                const scaleY = state.maskCanvas.height / rect.height;
                const cx = (x - rect.left) * scaleX;
                const cy = (y - rect.top) * scaleY;
                ctx.globalCompositeOperation = erase ? 'destination-out' : 'source-over';
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(cx, cy, CONFIG.brushSize * scaleX, 0, Math.PI * 2);
                ctx.fill();
                state.hasSelection = true;
            }

            // Drawing-Events (wie im Original ‚Äì kurz)
            elements.originalCanvas.addEventListener('mousedown', e => { state.isDrawing = true; drawOnMask(e.clientX, e.clientY, state.currentTool === 'erase'); updatePreview(); });
            elements.originalCanvas.addEventListener('mousemove', e => { if (state.isDrawing) { drawOnMask(e.clientX, e.clientY, state.currentTool === 'erase'); updatePreview(); } });
            document.addEventListener('mouseup', () => state.isDrawing = false);

            async function updatePreview() {
                if (!state.hasSelection) return;
                elements.loading.classList.add('active');

                try {
                    const originalDataURL = state.originalImage.toDataURL('image/jpeg', 0.95);
                    const maskDataURL = state.maskCanvas.toDataURL('image/png');

                    const response = await fetch('/api/recolor', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            originalImage: originalDataURL,
                            maskImage: maskDataURL,
                            targetColor: state.currentColor
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Fehler');

                    const img = new Image();
                    img.onload = () => {
                        elements.modifiedCanvas.getContext('2d').drawImage(img, 0, 0, elements.modifiedCanvas.width, elements.modifiedCanvas.height);
                        state.modifiedImage = elements.modifiedCanvas;
                        updateSliderPosition(50);
                        elements.loading.classList.remove('active');
                        showMessage('KI-Vorschau fertig ‚Äì photorealistisch! ‚ö°', 'success');
                    };
                    img.src = result.imageDataURL;
                } catch (err) {
                    elements.loading.classList.remove('active');
                    showMessage('KI-Fehler: ' + err.message, 'error');
                }
            }

            function initializeSlider() {
                let isSliding = false;
                const update = pct => {
                    elements.sliderHandle.style.left = pct + '%';
                    elements.sliderTrack.style.width = pct + '%';
                };
                elements.sliderHandle.addEventListener('mousedown', () => isSliding = true);
                document.addEventListener('mouseup', () => isSliding = false);
                document.addEventListener('mousemove', e => {
                    if (isSliding) {
                        const rect = elements.canvasStack.getBoundingClientRect();
                        const pct = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
                        update(pct);
                    }
                });
                update(50);
            }

            function updateButtonStates() {
                elements.downloadBtn.disabled = !state.hasSelection;
                elements.requestBtn.disabled = !state.hasSelection;
            }

            // Farbwahl, Download, Modal etc. (wie in deinem Original ‚Äì kurz gehalten)
            elements.colorPicker.addEventListener('input', e => {
                state.currentColor = e.target.value.toUpperCase();
                elements.colorInput.value = state.currentColor;
                updatePreview();
            });
            elements.colorInput.addEventListener('blur', () => {
                let hex = elements.colorInput.value.trim().toUpperCase();
                if (!hex.startsWith('#')) hex = '#' + hex;
                if (/^#[0-9A-F]{6}$/.test(hex)) {
                    state.currentColor = hex;
                    elements.colorPicker.value = hex;
                    updatePreview();
                }
            });

            CONFIG.predefinedColors.forEach(c => {
                const div = document.createElement('div');
                div.className = 'farbvorschau-color-option';
                div.innerHTML = `<div class="farbvorschau-color-option-box" style="background:${c.hex}">${c.name}</div>`;
                div.onclick = () => {
                    document.querySelectorAll('.farbvorschau-color-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    state.currentColor = c.hex;
                    elements.colorPicker.value = c.hex;
                    elements.colorInput.value = c.hex;
                    updatePreview();
                };
                elements.colorPalette.appendChild(div);
            });

            elements.brushTool.onclick = () => { state.currentTool = 'brush'; elements.brushTool.classList.add('active'); elements.eraseTool.classList.remove('active'); };
            elements.eraseTool.onclick = () => { state.currentTool = 'erase'; elements.eraseTool.classList.add('active'); elements.brushTool.classList.remove('active'); };
            elements.resetSelection.onclick = () => {
                state.maskCanvas.getContext('2d').clearRect(0, 0, state.maskCanvas.width, state.maskCanvas.height);
                state.maskCanvas.getContext('2d').fillStyle = 'black'; state.maskCanvas.getContext('2d').fillRect(0, 0, state.maskCanvas.width, state.maskCanvas.height);
                state.hasSelection = false; updateButtonStates(); updatePreview();
            };

            elements.downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.download = 'ki-farbvorschau.png';
                link.href = state.modifiedImage.toDataURL();
                link.click();
            };

            // Upload-Handler
            elements.uploadArea.onclick = () => elements.imageInput.click();
            elements.imageInput.onchange = e => e.target.files[0] && loadImage(e.target.files[0]);
            elements.uploadArea.ondragover = e => { e.preventDefault(); elements.uploadArea.style.borderColor = var(--color-primary-light); };
            elements.uploadArea.ondrop = e => { e.preventDefault(); loadImage(e.dataTransfer.files[0]); };

            // Init
            elements.colorPicker.value = '#00a8cc';
            elements.colorInput.value = '#00A8CC';
        })();
    </script>
</body>
</html>
